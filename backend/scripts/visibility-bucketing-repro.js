#!/usr/bin/env node
/**
 * Quick reproduction of WeatherService.fetchVisibility bucketing.
 * Paste from Open-Meteo hourly payload and run with `node visibility-bucketing-repro.js`.
 */

const timeBlocks = new Set([0, 3, 6, 12, 18, 21]);

const hourly = {
  time: [
    "2025-10-31T00:00",
    "2025-10-31T01:00",
    "2025-10-31T02:00",
    "2025-10-31T03:00",
    "2025-10-31T04:00",
    "2025-10-31T05:00",
    "2025-10-31T06:00",
    "2025-10-31T07:00",
    "2025-10-31T08:00",
    "2025-10-31T09:00",
    "2025-10-31T10:00",
    "2025-10-31T11:00",
    "2025-10-31T12:00",
    "2025-10-31T13:00",
    "2025-10-31T14:00",
    "2025-10-31T15:00",
    "2025-10-31T16:00",
    "2025-10-31T17:00",
    "2025-10-31T18:00",
    "2025-10-31T19:00",
    "2025-10-31T20:00",
    "2025-10-31T21:00",
    "2025-10-31T22:00",
    "2025-10-31T23:00",
    "2025-11-01T00:00",
    "2025-11-01T01:00",
    "2025-11-01T02:00",
    "2025-11-01T03:00",
    "2025-11-01T04:00",
    "2025-11-01T05:00",
    "2025-11-01T06:00",
    "2025-11-01T07:00",
    "2025-11-01T08:00",
    "2025-11-01T09:00",
    "2025-11-01T10:00",
    "2025-11-01T11:00",
    "2025-11-01T12:00",
    "2025-11-01T13:00",
    "2025-11-01T14:00",
    "2025-11-01T15:00",
    "2025-11-01T16:00",
    "2025-11-01T17:00",
    "2025-11-01T18:00",
    "2025-11-01T19:00",
    "2025-11-01T20:00",
    "2025-11-01T21:00",
    "2025-11-01T22:00",
    "2025-11-01T23:00",
    "2025-11-02T00:00",
    "2025-11-02T01:00",
    "2025-11-02T02:00",
    "2025-11-02T03:00",
    "2025-11-02T04:00",
    "2025-11-02T05:00",
    "2025-11-02T06:00",
    "2025-11-02T07:00",
    "2025-11-02T08:00",
    "2025-11-02T09:00",
    "2025-11-02T10:00",
    "2025-11-02T11:00",
    "2025-11-02T12:00",
    "2025-11-02T13:00",
    "2025-11-02T14:00",
    "2025-11-02T15:00",
    "2025-11-02T16:00",
    "2025-11-02T17:00",
    "2025-11-02T18:00",
    "2025-11-02T19:00",
    "2025-11-02T20:00",
    "2025-11-02T21:00",
    "2025-11-02T22:00",
    "2025-11-02T23:00",
    "2025-11-03T00:00",
    "2025-11-03T01:00",
    "2025-11-03T02:00",
    "2025-11-03T03:00",
    "2025-11-03T04:00",
    "2025-11-03T05:00",
    "2025-11-03T06:00",
    "2025-11-03T07:00",
    "2025-11-03T08:00",
    "2025-11-03T09:00",
    "2025-11-03T10:00",
    "2025-11-03T11:00",
    "2025-11-03T12:00",
    "2025-11-03T13:00",
    "2025-11-03T14:00",
    "2025-11-03T15:00",
    "2025-11-03T16:00",
    "2025-11-03T17:00",
    "2025-11-03T18:00",
    "2025-11-03T19:00",
    "2025-11-03T20:00",
    "2025-11-03T21:00",
    "2025-11-03T22:00",
    "2025-11-03T23:00",
    "2025-11-04T00:00",
    "2025-11-04T01:00",
    "2025-11-04T02:00",
    "2025-11-04T03:00",
    "2025-11-04T04:00",
    "2025-11-04T05:00",
    "2025-11-04T06:00",
    "2025-11-04T07:00",
    "2025-11-04T08:00",
    "2025-11-04T09:00",
    "2025-11-04T10:00",
    "2025-11-04T11:00",
    "2025-11-04T12:00",
    "2025-11-04T13:00",
    "2025-11-04T14:00",
    "2025-11-04T15:00",
    "2025-11-04T16:00",
    "2025-11-04T17:00",
    "2025-11-04T18:00",
    "2025-11-04T19:00",
    "2025-11-04T20:00",
    "2025-11-04T21:00",
    "2025-11-04T22:00",
    "2025-11-04T23:00",
    "2025-11-05T00:00",
    "2025-11-05T01:00",
    "2025-11-05T02:00",
    "2025-11-05T03:00",
    "2025-11-05T04:00",
    "2025-11-05T05:00",
    "2025-11-05T06:00",
    "2025-11-05T07:00",
    "2025-11-05T08:00",
    "2025-11-05T09:00",
    "2025-11-05T10:00",
    "2025-11-05T11:00",
    "2025-11-05T12:00",
    "2025-11-05T13:00",
    "2025-11-05T14:00",
    "2025-11-05T15:00",
    "2025-11-05T16:00",
    "2025-11-05T17:00",
    "2025-11-05T18:00",
    "2025-11-05T19:00",
    "2025-11-05T20:00",
    "2025-11-05T21:00",
    "2025-11-05T22:00",
    "2025-11-05T23:00",
    "2025-11-06T00:00",
    "2025-11-06T01:00",
    "2025-11-06T02:00",
    "2025-11-06T03:00",
    "2025-11-06T04:00",
    "2025-11-06T05:00",
    "2025-11-06T06:00",
    "2025-11-06T07:00",
    "2025-11-06T08:00",
    "2025-11-06T09:00",
    "2025-11-06T10:00",
    "2025-11-06T11:00",
    "2025-11-06T12:00",
    "2025-11-06T13:00",
    "2025-11-06T14:00",
    "2025-11-06T15:00",
    "2025-11-06T16:00",
    "2025-11-06T17:00",
    "2025-11-06T18:00",
    "2025-11-06T19:00",
    "2025-11-06T20:00",
    "2025-11-06T21:00",
    "2025-11-06T22:00",
    "2025-11-06T23:00",
  ],
  temperature_2m: [
    12.7, 12.6, 12.8, 12.7, 12.8, 12.8, 12.7, 12.7, 12.7, 13.3, 14, 15.4,
    17.2, 18.6, 19.9, 20.5, 20.2, 19, 17.2, 14.9, 13.5, 12.8, 12.3, 12,
    11.8, 11.5, 11.2, 11.1, 11.1, 11.2, 11, 11.1, 11.5, 12.9, 14.4, 16.2,
    17.8, 19.2, 20.6, 21.3, 21.4, 20.7, 18.3, 15.8, 14.3, 13.6, 13, 12.7,
    12.2, 11.8, 11.7, 11.5, 11, 10.6, 13.9, 13.8, 14.1, 16.7, 19.1, 20.9,
    23.3, 23.9, 24, 23.1, 19.4, 18.3, 17, 15.3, 14.2, 13.6, 13.4, 12.7,
    12.3, 11.9, 11.6, 11.3, 11, 10.7, 10.6, 10.6, 10.8, 12.9, 14.7, 16.6,
    17.9, 18.9, 18.7, 17.6, 16.9, 16.4, 14.6, 13.7, 13.3, 13, 13, 12.7,
    12.3, 12.3, 12.7, 12.6, 12.6, 12.4, 12.2, 12.3, 12.9, 15, 17.4, 19,
    20.8, 21.3, 21.6, 21.2, 20.7, 19.4, 17.7, 16.9, 16.4, 16.3, 16, 16,
    15.8, 15.6, 15.5, 15.6, 15.8, 16, 16.4, 16.8, 16.9, 16.6, 16.1, 15.8,
    15.9, 16.2, 16.4, 16.6, 16.8, 16.7, 16.1, 15.2, 14.4, 14.1, 13.9, 13.7,
    13.6, 13.6, 13.5, 13.3, 13, 12.8, 12.4, 12, 12.2, 13.2, 14.6, 15.9,
    16.9, 17.7, 18.2, 18.2, 17.8, 17.2, 16.1, 14.9, 13.9, 13.5, 13.4, 13.3,
  ],
  dewpoint_2m: [
    11.4, 11.3, 11.8, 11.9, 11.7, 11.7, 11.7, 12, 11.8, 12, 12.5, 13.4,
    13.7, 12.4, 11.9, 11.1, 10, 10, 9.8, 10.1, 10.9, 10.8, 10.7, 10.6, 10.6,
    10.3, 9.9, 10, 10, 10.4, 10.2, 10.5, 11.2, 12.6, 13.1, 13.7, 13.7, 13.6,
    12.8, 12.4, 12.5, 12.4, 12.3, 11.8, 12, 12, 11.4, 11.2, 10.9, 10.4, 9.8,
    9.5, 9.1, 8.7, 12.6, 12.4, 12.5, 12.9, 13.1, 13.1, 12.9, 12.5, 12.7, 12.7,
    13.3, 13, 12.8, 12.4, 11.9, 11.3, 11.1, 11.1, 11.1, 10.8, 10.7, 10.3,
    10.1, 9.9, 9.7, 9.7, 10.1, 10.6, 10.1, 9.3, 8.4, 7.4, 7.4, 8.2, 8, 7.6,
    8.3, 9.2, 9.2, 8.8, 8.6, 8.4, 8.2, 8, 7.8, 7.5, 7.5, 7.5, 7.5, 7.8, 8,
    8.3, 8.8, 9.5, 10.3, 10.8, 11, 11.3, 11.3, 11.7, 11.9, 12.1, 12.1, 12.2,
    12, 12.4, 12.4, 12.4, 12.3, 12.2, 12.1, 12.2, 12.1, 11.9, 12.1, 12.8,
    13.8, 14.3, 14.6, 14.7, 14.8, 14.8, 14.8, 14.7, 14.4, 13.9, 13.5, 13.1,
    12.9, 12.8, 12.7, 12.8, 12.7, 12.5, 12.2, 12, 11.6, 10.9, 10.6, 10.2,
    9.6, 8.9, 8.1, 7.5, 7, 7.3, 7.8, 8.3, 8.8, 9, 9.1, 8.7, 8.5, 8,
  ],
  visibility: [
    12600, 12900, 12900, 12200, 13200, 13300, 12600, 12200, 12700, 13100,
    13500, 15200, 18500, 25600, 29300, 32900, 35500, 32200, 28600, 21600,
    16300, 14700, 13900, 13100, 12400, 12200, 12200, 12200, 12200, 12200,
    12200, 400, 200, 2000, 13300, 16000, 19900, 23300, 28300, 30900, 31100,
    29400, 24100, 19200, 15100, 13500, 12900, 12900, 12600, 12600, 13500,
    13200, 12900, 12600, 24140, 24140, 24140, 24140, 24140, 24140, 24140,
    24140, 24140, 20580, 20580, 20840, 20760, 21160, 24140, 24140, 24140,
    24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140,
    24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140,
    24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140,
    24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140,
    24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140,
    24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140,
    24140, 24140, 24140, 17920, 11720, 5500, 11720, 17920, 24140, 21620,
    19080, 16560, 19080, 21620, 24140, 21200, 18260, 15320, 18260, 21200,
    24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140,
    24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140, 24140,
    24140, 24140, 24140,
  ],
  cloudcover: [
    90, 100, 100, 100, 100, 100, 100, 100, 88, 70, 74, 24, 5, 1, 0, 0, 2,
    53, 81, 100, 100, 100, 97, 100, 98, 65, 8, 12, 22, 31, 49, 89, 100, 88,
    58, 8, 6, 3, 2, 1, 0, 0, 0, 0, 0, 1, 4, 2, 3, 4, 3, 4, 3, 7, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0,
    0, 33, 20, 36, 60, 100, 100, 100, 100, 8, 61, 80, 16, 23, 100, 99, 62,
    89, 100, 100, 87, 93, 60, 71, 100, 94, 92, 100, 100, 100, 100, 100,
    100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
    100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 85, 71, 56, 54, 53,
    51, 65, 80, 94, 96, 98, 100, 100, 100, 100, 92, 85, 77, 65, 53, 41, 30,
    19, 8, 5, 3, 0, 1, 1, 2,
  ],
  relative_humidity_2m: [
    92, 92, 94, 95, 93, 93, 94, 96, 94, 92, 91, 88, 80, 67, 60, 55, 52, 56,
    62, 73, 84, 88, 90, 91, 92, 92, 92, 93, 93, 95, 95, 96, 98, 98, 92, 85,
    77, 70, 61, 57, 57, 59, 68, 77, 86, 90, 90, 91, 92, 91, 88, 88, 88, 88,
    92, 91, 90, 78, 68, 61, 52, 49, 49, 52, 68, 71, 76, 83, 86, 86, 86, 90,
    92, 93, 94, 94, 94, 95, 94, 94, 95, 86, 74, 62, 54, 47, 48, 54, 56, 56,
    66, 74, 76, 76, 75, 75, 76, 75, 72, 71, 71, 72, 73, 74, 72, 64, 57, 54,
    51, 51, 51, 53, 55, 61, 69, 73, 76, 77, 77, 79, 80, 81, 81, 80, 79, 78,
    76, 73, 73, 78, 86, 91, 92, 91, 90, 89, 88, 88, 90, 92, 94, 94, 94, 94,
    94, 95, 95, 95, 95, 95, 95, 93, 90, 82, 72, 63, 56, 51, 48, 49, 52, 56,
    62, 68, 73, 73, 72, 70,
  ],
  precipitation_probability: [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
    1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 8, 8,
    8, 8, 8, 8, 21, 21, 21, 21, 21, 21, 54, 54, 54, 54, 54, 54, 68, 68, 68,
    68, 68, 68, 37, 37, 37, 37, 37, 37, 15, 15, 15, 15, 15, 15, 4, 4, 4, 4,
    4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,
  ],
  windspeed_10m: [
    6.3, 4.6, 5.3, 5.6, 5.2, 4.3, 5.1, 4.3, 3.1, 3.4, 3.1, 4.6, 6.2, 8.7,
    9, 8.6, 8.4, 6.5, 4.1, 6.7, 7.2, 7.9, 7.8, 7.9, 8, 7.6, 7.7, 7.9, 7.9,
    7.6, 6.9, 7.1, 6.9, 8.2, 7.2, 5.1, 5.4, 6, 6.6, 6.5, 6.6, 5.2, 4.6, 6.5,
    7.6, 8.4, 7.2, 7.7, 7.6, 7.4, 8.2, 7.9, 7.6, 7.6, 2.9, 2.3, 1.6, 4.1,
    5.8, 7.2, 4.4, 7.7, 8.6, 9.7, 11.7, 6.6, 6.2, 7.4, 5.4, 5.1, 7.6, 4,
    6, 5.3, 5.2, 3.8, 3.3, 4.7, 3.7, 4.4, 4.6, 4.7, 7, 5.6, 7.4, 7, 8.1,
    9.2, 8, 8.3, 7.6, 7.9, 6.6, 4.4, 3.4, 4.7, 4.1, 4.7, 4.2, 4.2, 2.2, 1,
    0.4, 2.1, 4.6, 3.3, 4.2, 5.4, 5.7, 6, 6.2, 7.2, 9.8, 7.8, 6.9, 6.6, 4.5,
    2.6, 9.3, 9, 11.4, 13.1, 15.3, 17.7, 20.3, 22.9, 26, 29.4, 32.1, 34, 35.5,
    35.3, 33.6, 31.1, 29, 25.9, 21.7, 17.7, 13.8, 10, 7.2, 5.5, 4.8, 4.3,
    3.8, 3.9, 3.8, 3.1, 3.6, 5, 6.2, 6.9, 7.7, 8, 7.7, 7.7, 8.2, 8.7, 8.9,
    8.6, 8.6, 8.4, 7.1, 5.7, 5, 4.8, 4.7, 4.7,
  ],
  wind_direction_10m: [
    167, 162, 152, 153, 164, 132, 94, 114, 111, 72, 339, 321, 324, 312, 307,
    292, 277, 270, 195, 164, 153, 150, 146, 150, 144, 135, 139, 141, 137,
    135, 133, 135, 129, 139, 153, 176, 217, 237, 257, 264, 257, 254, 231,
    174, 149, 155, 153, 143, 149, 137, 131, 141, 149, 149, 90, 72, 27, 315,
    292, 288, 235, 259, 255, 270, 288, 279, 277, 284, 278, 274, 275, 243,
    245, 242, 245, 221, 186, 176, 209, 235, 225, 189, 215, 207, 241, 235,
    249, 259, 260, 265, 267, 273, 257, 235, 212, 171, 165, 157, 160, 149,
    171, 225, 90, 121, 135, 167, 160, 172, 198, 237, 260, 276, 287, 304, 332,
    338, 331, 124, 152, 164, 156, 148, 146, 147, 150, 154, 158, 163, 167,
    170, 174, 178, 186, 196, 205, 209, 212, 213, 213, 210, 207, 212, 222,
    228, 221, 202, 197, 225, 270, 291, 306, 317, 323, 324, 323, 323, 322,
    318, 313, 303, 285, 277, 285, 305, 330, 347, 356, 4,
  ],
  boundary_layer_height: [
    310, 160, 130, 250, 145, 240, 185, 200, 230, 290, 400, 365, 360, 335,
    360, 400, 375, 335, 130, 45, 45, 45, 50, 50, 55, 50, 50, 70, 100, 105,
    90, 95, 130, 265, 335, 355, 365, 385, 430, 430, 410, 375, 135, 90, 40,
    45, 30, 40, 40, 35, 30, 30, 30, 30, 30, 10, 10, 10, 105, 260, 380, 425,
    575, 555, 445, 290, 195, 60, 70, 50, 30, 65, 15, 25, 25, 20, 20, 20, 15,
    15, 15, 20, 280, 420, 435, 540, 480, 470, 445, 350, 345, 130, 85, 45, 20,
    15, 15, 15, 15, 15, 10, 10, 10, 10, 10, 10, 80, 205, 315, 475, 590, 645,
    665, 600, 300, 40, 30, 15, 15, 65, 80, 120, 175, 270, 440, 645, 810, 895,
    940, 985, 1060, 1135, 1150, 1060, 915, 785, 725, 680, 600, 425, 205, 45,
    0, 0, 10, 5, 10, 10, 10, 10, 10, 0, 0, 40, 200, 420, 620, 790, 940, 990,
    885, 680, 480, 305, 130, 10, 0, 0, 1,
  ],
};

const buckets = {};

for (let i = 0; i < hourly.time.length; i++) {
  const dt = new Date(hourly.time[i]);
  const hr = dt.getHours();
  if (!timeBlocks.has(hr)) continue;

  const dateKey = dt.toISOString().split('T')[0];

  buckets[dateKey] ??= {
    date: dateKey,
    conditions: {
      temperature: {},
      dewpoint: {},
      visibility: {},
      cloudcover: {},
      humidity: {},
      precipitation: {},
      windspeed: {},
      winddirection: {},
      seeing: {},
    },
  };

  buckets[dateKey].conditions.temperature[hr] = hourly.temperature_2m[i];
  buckets[dateKey].conditions.dewpoint[hr] = hourly.dewpoint_2m[i];
  buckets[dateKey].conditions.visibility[hr] = hourly.visibility[i];
  buckets[dateKey].conditions.cloudcover[hr] = hourly.cloudcover[i];
  buckets[dateKey].conditions.humidity[hr] =
    hourly.relative_humidity_2m[i];
  buckets[dateKey].conditions.precipitation[hr] =
    hourly.precipitation_probability[i];
  buckets[dateKey].conditions.windspeed[hr] = hourly.windspeed_10m[i];
  buckets[dateKey].conditions.winddirection[hr] =
    hourly.wind_direction_10m[i];
  buckets[dateKey].conditions.seeing[hr] = hourly.boundary_layer_height[i];
}

console.dir(buckets, { depth: null });
